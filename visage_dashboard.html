<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ΔΩ.156 VISAGE | Sovereign Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Courier New', Courier, monospace;
        }

        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(255, 255, 255, 0.04) 50%, rgba(0, 0, 0, 0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% {
                bottom: 100%;
            }

            100% {
                bottom: -100px;
            }
        }

        .flicker {
            animation: flicker 0.15s infinite;
        }

        @keyframes flicker {
            0% {
                opacity: 0.9;
            }

            50% {
                opacity: 1.0;
            }

            100% {
                opacity: 0.9;
            }
        }
    </style>
</head>

<body class="overflow-hidden h-screen w-screen relative">
    <div class="scanline"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createClient } = window.supabase;

        // --- CREDENTIALS INJECTED BY SOVEREIGN AGENT ---
        const SUPABASE_URL = "https://xlmrnjatawslawquwzpf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsbXJuamF0YXdzbGF3cXV3enBmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTU5NDE4NCwiZXhwIjoyMDc1MTcwMTg0fQ.F9d8xPv2iw1Jnbl_O68Yi2tDh7u-7xrh4rCxU-lc-KQ";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const Visage = () => {
            const [fossils, setFossils] = useState([]);
            const [scarIndex, setScarIndex] = useState(1.0); // Default perfect coherence
            const [status, setStatus] = useState("CONNECTING...");
            const [economy, setEconomy] = useState({ total_supply: 0, lifetime_avg: 0, current_yield: 0 });
            const scrollRef = useRef(null);

            // --- PARSING LOGIC ---
            const extractScarIndex = (description) => {
                // Look for "scarindex": 0.xx in the string
                try {
                    // The description is like "VN: {'delta_c': 0.2, 'scarindex': 0.95}"
                    // We can try a regex
                    const match = description.match(/'scarindex':\s*([0-9.]+)/);
                    if (match && match[1]) {
                        return parseFloat(match[1]);
                    }
                } catch (e) {
                    console.error("Parse error", e);
                }
                return null;
            };

            // --- DATA STREAM ---
            useEffect(() => {
                const fetchInitial = async () => {
                    const { data, error } = await supabase
                        .table('attestations')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(50);

                    if (data) {
                        setFossils(data);
                        // Find latest ScarIndex
                        for (let f of data) {
                            const si = extractScarIndex(f.description);
                            if (si !== null) {
                                setScarIndex(si);
                                break;
                            }
                        }
                        setStatus("ONLINE");
                    }

                    // Fetch Economy
                    const { data: ecoData, error: ecoError } = await supabase.rpc('get_economic_snapshot');
                    if (ecoData) {
                        setEconomy(ecoData);
                    }
                };

                fetchInitial();

                const channel = supabase
                    .channel('public:attestations')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attestations' }, async (payload) => {
                        console.log('New Fossil:', payload.new);
                        const newFossil = payload.new;
                        setFossils(prev => [newFossil, ...prev]);

                        const si = extractScarIndex(newFossil.description);
                        if (si !== null) setScarIndex(si);

                        // Refresh Economy on new insert
                        const { data: ecoData } = await supabase.rpc('get_economic_snapshot');
                        if (ecoData) setEconomy(ecoData);
                    })
                    .subscribe();

                return () => supabase.removeChannel(channel);
            }, []);

            // --- VISUAL LOGIC ---
            const getStatusColor = () => {
                if (scarIndex < 0.3) return "text-red-500 animate-pulse"; // F4 Panic
                if (scarIndex < 0.7) return "text-yellow-400"; // Warning
                return "text-emerald-400"; // Healthy
            };

            const getOrbColor = () => {
                if (scarIndex < 0.3) return "bg-red-600 shadow-[0_0_50px_rgba(220,38,38,0.8)]";
                if (scarIndex < 0.7) return "bg-yellow-500 shadow-[0_0_30px_rgba(234,179,8,0.6)]";
                return "bg-emerald-500 shadow-[0_0_30px_rgba(16,185,129,0.6)]";
            };

            // --- ACTIONS ---
            const triggerPanic = async () => {
                // Manually inject a Panic Pulse
                const payload = {
                    source: "VISAGE_MANUAL_OVERRIDE",
                    description: "VN: {'signal': 'MANUAL_F4_TRIGGER', 'scarindex': 0.10}",
                    volume: 99,
                    complexity: 9.9,
                    entropy: 1.0
                };
                await supabase.table('attestations').insert(payload);
            };

            return (
                <div className="flex h-full">
                    {/* LEFT: MONITOR */}
                    <div className="w-1/3 border-r border-slate-800 p-8 flex flex-col items-center justify-center relative bg-slate-900/50">
                        <h1 className="absolute top-8 left-8 text-2xl font-bold tracking-widest text-slate-400">ΔΩ.156</h1>

                        {/* ORB */}
                        <div className={`w-48 h-48 rounded-full transition-all duration-1000 flex items-center justify-center ${getOrbColor()} mb-8`}>
                            <div className="text-4xl font-bold text-white drop-shadow-md">
                                {scarIndex.toFixed(2)}
                            </div>
                        </div>

                        <div className={`text-xl font-mono tracking-wider ${getStatusColor()}`}>
                            {scarIndex < 0.3 ? "CRITICAL FAILURE (F4)" : scarIndex < 0.7 ? "UNSTABLE" : "COHERENCE STABLE"}
                        </div>

                        {/* PANIC SWITCH */}
                        <button
                            onClick={triggerPanic}
                            className="mt-12 px-8 py-3 border border-red-900 text-red-900 hover:bg-red-900 hover:text-white transition-colors font-mono text-sm tracking-widest uppercase"
                        >
                            [ MANUAL F4 TRIGGER ]
                        </button>

                        {/* ECONOMY DECK */}
                        <div className="mt-12 w-full border-t border-slate-800 pt-8">
                            <div className="flex justify-between mb-4">
                                <span className="text-slate-500 text-xs tracking-widest">TOTAL SUPPLY</span>
                                <span className="text-emerald-400 font-mono text-xl">{economy.total_supply ? Number(economy.total_supply).toFixed(4) : "0.0000"} SCAR</span>
                            </div>
                            <div className="flex justify-between mb-2">
                                <span className="text-slate-500 text-xs tracking-widest">LIFETIME YIELD</span>
                                <span className="text-slate-300 font-mono text-sm">{economy.lifetime_avg ? Number(economy.lifetime_avg).toFixed(4) : "0.0000"} / cycle</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-slate-500 text-xs tracking-widest">CURRENT YIELD (100)</span>
                                <span className={`${economy.current_yield > economy.lifetime_avg ? 'text-emerald-400' : 'text-yellow-400'} font-mono text-sm`}>
                                    {economy.current_yield ? Number(economy.current_yield).toFixed(4) : "0.0000"} / cycle
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* RIGHT: FOSSIL STREAM */}
                    <div className="w-2/3 p-8 bg-black flex flex-col">
                        <div className="flex justify-between items-end mb-6 border-b border-slate-800 pb-2">
                            <h2 className="text-lg text-slate-500 font-mono">TRUTH_VAULT // LIVE_FEED</h2>
                            <span className="text-xs text-slate-600 animate-pulse">● {status}</span>
                        </div>

                        <div className="flex-1 overflow-y-auto font-mono text-sm space-y-2 pr-2" ref={scrollRef}>
                            {fossils.map((fossil) => (
                                <div key={fossil.id} className="p-3 border-l-2 border-slate-800 bg-slate-900/30 hover:bg-slate-800/50 transition-colors group">
                                    <div className="flex justify-between text-xs text-slate-500 mb-1">
                                        <span>ID: {fossil.id}</span>
                                        <span>{new Date(fossil.created_at).toLocaleTimeString()}</span>
                                    </div>
                                    <div className="text-slate-300 group-hover:text-white break-all">
                                        <span className="text-purple-400 mr-2">[{fossil.source}]</span>
                                        {fossil.description}
                                    </div>
                                    {fossil.final_wi_score && (
                                        <div className="text-xs text-slate-600 mt-1">
                                            ENERGY: {fossil.final_wi_score} J
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Visage />);
    </script>
</body>

</html>