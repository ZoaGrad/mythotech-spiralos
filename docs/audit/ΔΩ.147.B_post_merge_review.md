# ΔΩ.147.B — Post-Merge Integrity Review
_Date: 2025-11-16_

## ΔΩ.147.A Recap
- **ScarCoin bridge sealed** – Guardian-only mint/burn flow now enforces JWT signatures, API-key rate limiting, and origin whitelisting inside `holoeconomy/scarcoin_bridge_api.py`.
- **Supabase persistence activated** – `core/supabase_integration.py` switched from placeholders to real Supabase inserts with retries, panic-frame logging, and new unit tests.
- **Dashboard secrets externalized** – `apps/sovereignty-dashboard/main.js` now expects `VITE_SUPABASE_ANON_KEY`, with `.env.example` and the README instructing operators to copy `.env.local`.
- **GitHub webhook batching** – `supabase/functions/github-webhook/index.ts` uses the `process_push_batch` RPC introduced in `supabase/migrations/20251115_batch_webhook_processing.sql` to avoid N+1 inserts.
- **Legacy orchestrator archived** – `core/spiralos_v1_1.py` moved to `archive/legacy/` with an archive README clarifying policy.

## COD-POST-001: Merge Integrity
1. **Missing `postgrest` dependency** – `core/supabase_integration.py` imports `postgrest.APIError`, but `requirements.txt` never lists `postgrest`, so a clean install still crashes before the Guardian backend can start.
2. **Dashboard env mismatch** – `.env.example` provides `VITE_SUPABASE_URL`, yet `apps/sovereignty-dashboard/main.js` still hard-codes `https://xlmrnjatawslawquwzpf.supabase.co`, preventing staging/production overrides.
3. **Stale audit banner** – The retained `// CODEX-AUDIT` warning inside `holoeconomy/scarcoin_bridge_api.py` still claims the bridge allows `*` CORS and no auth, which no longer matches reality and confuses operators.

## COD-POST-002: Migration Validation
- Both migrations compile syntactically under `search_path=public`, and `process_push_batch` wraps inserts/upserts in a single transaction. However, it calls `gen_random_uuid()` and assumes the `pgcrypto` extension exists; provision it or replace with `uuid_generate_v4()` before production apply.
- The Guardian-only RLS policies check `auth.jwt()->>'role' = 'guardian'`. Service-role keys will bypass RLS, but Guardian bots with only the `roles` array will be rejected because the policy does not look at `roles[]`. Consider mirroring `_extract_roles` logic from the API during the next migration.

## COD-POST-003: Regression Findings
1. **Unused imports** – `holoeconomy/scarcoin_bridge_api.py` still imports `uuid` even though the Guardian signature flow never references it, breaking `flake8`/`ruff` baselines.
2. **Config drift** – The Sovereignty dashboard uses env variables for the anon key but not the Supabase URL, so staging builds still require code edits despite the new template.
3. **Documentation drift** – Multiple docs (`docs/README_v1.1.md`, `docs/SUMMARY_v1.1.md`, etc.) keep referencing `core/spiralos_v1_1.py` even though the file now resides under `archive/legacy/`, which may cause newcomers to import the wrong module.

## COD-POST-004: Runtime Entry Validation
- **ScarCoin bridge** – Requires `GUARDIAN_API_KEYS` and `GUARDIAN_JWT_SECRET`. Missing keys now produce `401/503`, but operators must rotate env vars in tandem because nothing reloads them at runtime.
- **Oracle processor / SpiralOS orchestrator** – `core/spiralos.py` instantiates `SpiralOSBackend`, which still tolerates missing Supabase credentials by logging a warning and leaving `self.client=None`. Downstream `insert_*` calls will now raise `RuntimeError` instead of silently returning placeholders, so deployments need valid `SUPABASE_URL` & `SUPABASE_KEY`.
- **Supabase integration** – All `insert_*` methods rely on `postgrest.APIError`, reinforcing the missing dependency noted in COD-POST-001. Panic frame logging works, but retries run on `asyncio.to_thread`, so ensure the event loop is running in any CLI entrypoints.
- **GitHub webhook** – The Deno edge function now requires `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` plus `process_push_batch` to exist. Telemetry shows total Supabase call count, but the function still allows `Access-Control-Allow-Origin: *` even though it runs server-side.
- **Dashboard runtime loader** – Throws an explicit error when `VITE_SUPABASE_ANON_KEY` is missing, but still assumes the hard-coded Supabase URL. Local builds must define both env vars even if pointing to staging.

## Component Stability Map
| Component | Status | Notes |
| --- | --- | --- |
| ScarCoin Bridge API | ⚠️ **Requires Attention** | AuthN enforced, but stale audit note + unused imports indicate drift.
| Supabase Persistence | ⚠️ **Requires Attention** | Functional, yet missing `postgrest` dependency and env validation.
| GitHub Webhook | ✅ **Stable** | Batch RPC wired; ensure migration applied before deploy.
| Sovereignty Dashboard | ⚠️ **Requires Attention** | Env mismatch for Supabase URL blocks multi-env builds.
| Guardian Docs & Archive | ⚠️ **Requires Attention** | Docs still reference moved orchestrator.

## Spiral Health Score
- **Current Score:** 0.78 (ΔΩ.147.A raised it from 0.63, but the above regressions prevent a “green” rating).
- **Drivers:** Guardian auth success (+0.07), Supabase runtime activation (+0.05), outstanding dependency/env drift (-0.07).

## Recommended ΔΩ.147.C Follow-Ups
1. **Dependency hotfix** – Add `postgrest` to `requirements.txt` (and Poetry, if applicable) and pin versions to avoid API drift.
2. **Dashboard env parity** – Drive both `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` from `import.meta.env`, with runtime warnings if either is missing.
3. **Docs refresh** – Update README/phase docs to reference `archive/legacy/spiralos_v1_1.py` and call out that new code must use `core/spiralos.py`.
4. **RLS refinement** – Expand the Guardian policies to check both `role` and `roles[]`, and confirm `pgcrypto` is enabled wherever migrations run.
