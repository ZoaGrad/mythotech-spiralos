# ΔΩ.147.G — Cleanup + CI Restore

_Assessment window: post-ΔΩ.147.F seal → HEAD of ΔΩ.147.G wave._

## Scope recap
- Repo-wide `autoflake --remove-all-unused-imports`, `isort`, and `black` sweeps plus a new `.flake8` profile (max line length 120, excludes `node_modules/`, `archive/`, `liquidity_mirror/`, `v1.5B_legitimacy/`, `.github/`, `supabase/functions/`, `scripts/etl/node_modules/`).
- Added `tests/conftest.py` (at repo root) to seed safe Supabase/Guardian defaults, auto-stub `supabase.create_client`, and centralize pytest fixtures.
- Hardened `core/config.py` to emit deterministic defaults when `SUPABASE_*` / Guardian secrets are absent so CI never fails due to missing env vars.
- Repaired Ed25519 handling inside `holoeconomy/holobridge/vault_sync.py` by moving to `cryptography`'s primitives for signing + verification.
- Guarded network entry points: HTTPS validation for Guardian scripts, localhost-only uvicorn bindings for the ScarIndex services, and path hygiene for legacy scripts.

## Linting + style normalization
- `autoflake/isort/black` were executed iteratively until `flake8 .` reported 0 violations under the new config.
- Removed ad-hoc `sys.path` manipulation in tests; fixtures now import modules using package-relative semantics.
- Cleaned stray `F541`, `F841`, `E402`, `E501`, and trailing whitespace warnings across `core/`, `holoeconomy/`, `scripts/`, and `tests/`.

## Runtime & security hardening highlights
- **Guardian scripts:** `_require_https` helper enforces TLS for `GUARDIAN_EDGE_URL` + Discord webhooks; urllib calls remain but are annotated with `# nosec B310` and justified below.
- **Discord + Supabase scripts:** Added lightweight HTTPS validation wrappers before making outbound requests.
- **holoeconomy services:** `scarcoin_bridge_api.py` and `scarindex_oracle.py` now bind uvicorn to `127.0.0.1`, eliminating Bandit B104 warnings while keeping local dev unaffected (operators must front them with a proxy when exposing externally).
- **Vault sync bridge:** Deprecated `Crypto.Signature.eddsa` usage replaced with `cryptography.hazmat.primitives.asymmetric.ed25519` for cross-platform compatibility.

## Bandit status (`bandit -r . -x node_modules,scripts/etl/node_modules,supabase/functions,.github,archive,liquidity_mirror,v1.5B_legitimacy -f json -o bandit.json`)
- Results stored in `bandit.json` for CI auditing.
- Severity counts: **0 high / 0 medium / 207 low** (lows are deterministic randomness calls in stress tests plus benign asserts inside test helpers).
- Inline suppressions:
  - `core/guardian/scripts/field_sync.py`: urllib usage tagged with `# nosec B310` because `_require_https` ensures HTTPS-only URLs before execution.
  - `core/guardian/scripts/post_to_discord.py`: the Discord webhook call is similarly guarded by `_require_https` and annotated `# nosec B310`.
- No additional ignores were necessary; previous B104 hits vanished once uvicorn was restricted to localhost.

## Verification matrix
| Command | Result |
| --- | --- |
| `pytest -v` | ✅ `73 passed / 12 skipped` (Guardian analytics skips are intentional when heavy modules are unavailable). |
| `flake8 .` | ✅ Clean after repo-wide autoflake/isort/black normalization. |
| `bandit -r ... -f json -o bandit.json` | ✅ `0 high / 0 medium / 207 low` (see suppressions above). |

## Outstanding considerations
- Guardian & Supabase fixtures mock out network IO; integration tests with live services should return once CI secrets can be injected safely.
- The Ed25519 migration lacks direct unit tests—plan to add targeted coverage in ΔΩ.148 to prove verification failure paths.
- Operators deploying `scarcoin_bridge_api.py` or `scarindex_oracle.py` must place them behind a proxy/load balancer because the uvicorn entry points now bind to `127.0.0.1` only.
